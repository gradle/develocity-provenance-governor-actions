name: Continuous Integration

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    name: Build and run tests
    runs-on: ubuntu-latest

    env:
      DEVELOCITY_URL: https://develocity-ext-github.grdev.net

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 #v6.0.1

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 #v6.2.0
        with:
          node-version-file: .node-version
          cache: npm

      - name: Setup Develocity for npm
        uses: gradle/develocity-actions/setup-npm@974e8dbcbda40db6828fc35f349c80a7c0e71529 #v2.1
        with:
          develocity-injection-enabled: true
          develocity-access-key: >
            develocity-ext-github.grdev.net=${{ secrets.DEVELOCITY_ACCESS_KEY }}
          develocity-url: https://develocity-ext-github.grdev.net

      - name: Install Dependencies
        id: npm-ci
        run: npm ci

      - name: Check Format
        id: npm-format-check
        run: npm run format:check

      - name: Lint
        id: npm-lint
        run: npm run lint

      - name: Test
        id: npm-test
        run: npm run test

      - name: Package
        id: npm-package
        run: npm run package
